# OpenCode-Mem 设计理念与实现思路

## 设计理念

### 核心问题

AI 编程助手的会话是**无状态**的。每次新会话都从零开始，需要重复解释项目背景、之前做过什么、为什么这么做。这导致：

1. **重复劳动** - 每次都要重新理解项目上下文
2. **信息丢失** - 之前的决策、发现、踩过的坑都无法传承
3. **效率低下** - 无法在之前的工作基础上继续

### 解决方案

**渐进式持久记忆** - 让 AI 助手"记得"之前会话中的工作，并在新会话中自动注入相关上下文。

```
┌─────────────────────────────────────────────────────────────────┐
│                     OpenCode-Mem 核心理念                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   "让 AI 记住过去，是为了更好地工作在现在"                          │
│                                                                 │
│   不是存储所有东西 → 而是压缩、提炼、按需检索                        │
│   不是简单搜索    → 而是语义理解、渐进式披露                         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 系统架构

```
                              OpenCode-Mem 架构图
                              
┌──────────────────────────────────────────────────────────────────────┐
│                           OpenCode Host                               │
│  ┌────────────┐   ┌────────────┐   ┌────────────┐   ┌────────────┐   │
│  │  Session   │   │   Tool     │   │   Chat     │   │  System    │   │
│  │  Created   │──▶│  Execute   │──▶│  Message   │──▶│  Transform │   │
│  │   Hook     │   │   Hooks    │   │   Hook     │   │   Hook     │   │
│  └─────┬──────┘   └─────┬──────┘   └─────┬──────┘   └─────┬──────┘   │
│        │                │                │                │           │
└────────┼────────────────┼────────────────┼────────────────┼───────────┘
         │                │                │                │
         ▼                ▼                ▼                ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         opencode-mem Plugin                          │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                      Event Capture Layer                      │    │
│  │                                                               │    │
│  │   sessionCreated()    toolExecuteAfter()    chatMessage()    │    │
│  │        │                    │                    │           │    │
│  │        ▼                    ▼                    ▼           │    │
│  │   ┌─────────┐        ┌─────────────┐      ┌──────────┐      │    │
│  │   │ Session │        │   Pending   │      │  User    │      │    │
│  │   │  Record │        │ Compression │      │  Prompt  │      │    │
│  │   └─────────┘        │    Queue    │      └──────────┘      │    │
│  │                      └──────┬──────┘                         │    │
│  └─────────────────────────────┼────────────────────────────────┘    │
│                                │                                      │
│  ┌─────────────────────────────▼────────────────────────────────┐    │
│  │                   Compression Layer                           │    │
│  │                                                               │    │
│  │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │    │
│  │   │   Raw       │────▶│    AI       │────▶│  Structured │   │    │
│  │   │   Event     │     │  Compressor │     │ Observation │   │    │
│  │   │  (5KB)      │     │  (OpenCode) │     │   (500B)    │   │    │
│  │   └─────────────┘     └─────────────┘     └─────────────┘   │    │
│  │                                               │               │    │
│  └───────────────────────────────────────────────┼───────────────┘    │
│                                                  │                    │
│  ┌───────────────────────────────────────────────▼───────────────┐    │
│  │                     Storage Layer                              │    │
│  │                                                                │    │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐       │    │
│  │   │   SQLite    │    │   FTS5      │    │   Chroma    │       │    │
│  │   │   Database  │◀───│   Full-Text │◀───│   Vector    │       │    │
│  │   │             │    │   Search    │    │   Search    │       │    │
│  │   └─────────────┘    └─────────────┘    └─────────────┘       │    │
│  │                                                                │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                       │
│  ┌────────────────────────────────────────────────────────────────┐   │
│  │                   Context Injection Layer                       │   │
│  │                                                                 │   │
│  │   systemTransform()                                             │   │
│  │        │                                                        │   │
│  │        ▼                                                        │   │
│  │   ┌─────────────────────────────────────────────────────────┐  │   │
│  │   │  1. Identify current project                             │  │   │
│  │   │  2. Fetch recent observations (by project, by time)      │  │   │
│  │   │  3. Build context within token budget (~2000 tokens)     │  │   │
│  │   │  4. Mark observations as "injected"                      │  │   │
│  │   │  5. Inject into system prompt                            │  │   │
│  │   └─────────────────────────────────────────────────────────┘  │   │
│  │                                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────────┐
│                         HTTP API + Web Viewer                           │
│                                                                        │
│    Port 37778                                                          │
│    ┌──────────────────────────────────────────────────────────────┐    │
│    │  /api/sessions      - List all sessions                      │    │
│    │  /api/timeline/:id   - Get session observations               │    │
│    │  /api/search?q=...   - Full-text search                       │    │
│    │  /api/observations/:id - Get observation detail               │    │
│    │  /                   - Web Viewer UI                          │    │
│    └──────────────────────────────────────────────────────────────┘    │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

## 数据流

```
                           数据流图
                           
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   User      │     │   OpenCode  │     │   Plugin    │     │   Storage   │
│   Action    │────▶│   Event     │────▶│   Capture   │────▶│   Layer     │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                                                                    │
     ┌──────────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Compression Pipeline                            │
│                                                                         │
│  Tool Output (raw)                                                      │
│       │                                                                 │
│       ▼  [10x compression]                                              │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ <observation>                                                    │   │
│  │   <type>code_change</type>                                       │   │
│  │   <title>Added path preview feature</title>                     │   │
│  │   <narrative>Implemented 3-step trajectory preview for          │   │
│  │   snake game with visual indicators...</narrative>              │   │
│  │   <files_modified><file>src/Preview.tsx</file></files_modified> │   │
│  │ </observation>                                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          Context Injection                               │
│                                                                         │
│  New Session Start                                                      │
│       │                                                                 │
│       ▼                                                                 │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ ## Memory from Previous Sessions                                 │   │
│  │                                                                  │   │
│  │ ### Recent Observations                                          │   │
│  │ - **Added path preview feature**: code_change                    │   │
│  │ - **Fixed responsive breakpoints**: bug_fix                      │   │
│  │ - **Discovered API rate limits**: discovery                      │   │
│  │ ...                                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 事件捕获层 (Event Capture)

```
┌──────────────────────────────────────────────────────────────┐
│                    Hook System                                │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  session.created    →  Record new session + project          │
│                                                              │
│  tool.execute.after →  Queue tool output for compression     │
│                                                              │
│  chat.message       →  Store user prompts                    │
│                                                              │
│  system.transform   →  Inject memory context                 │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 2. 压缩层 (Compression)

```
┌──────────────────────────────────────────────────────────────┐
│                    AI Compression                             │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  输入: Raw tool output (可能 5-10KB)                          │
│                                                              │
│  处理:                                                       │
│    1. 提取关键信息                                            │
│    2. 识别操作类型 (tool_use/code_change/discovery/...)      │
│    3. 生成结构化摘要                                          │
│    4. 提取文件路径、概念标签                                   │
│                                                              │
│  输出: Observation (~500 bytes)                              │
│                                                              │
│  压缩比: ~10-20x                                             │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 3. 存储层 (Storage)

```
┌──────────────────────────────────────────────────────────────┐
│                    SQLite + FTS5                              │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  tables:                                                     │
│    - sessions        (session_id, project, user_prompt)      │
│    - observations    (type, title, narrative, facts, ...)    │
│    - user_prompts    (prompt_text, prompt_number)            │
│    - pending_compressions (queue for async processing)       │
│                                                              │
│  indexes:                                                    │
│    - observations_fts (full-text search)                     │
│    - by project, by session, by created_at, by injected_at   │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

### 4. 上下文注入层 (Context Injection)

```
┌──────────────────────────────────────────────────────────────┐
│                    Progressive Disclosure                     │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  Token Budget: ~2000 tokens (可配置)                          │
│                                                              │
│  策略:                                                       │
│    1. 优先级: 同 project > 最近时间 > 未注入过的               │
│    2. 格式: 紧凑的 Markdown 列表                               │
│    3. 截断: 超出预算则停止添加                                  │
│                                                              │
│  标记:                                                       │
│    - injected_at 记录注入时间                                 │
│    - UI 中显示紫色 "Injected" 标记                             │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## 3-Layer 搜索工作流

```
┌─────────────────────────────────────────────────────────────────────┐
│                        3-Layer Search Workflow                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Layer 1: search()                                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  返回: ID + 标题 + 简短摘要                                    │   │
│  │  Token: ~50-100 / 结果                                        │   │
│  │  用途: 快速筛选相关结果                                        │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                           │                                         │
│                           ▼                                         │
│  Layer 2: timeline()                                                │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  返回: 时间线上下文 (某个 observation 前后的相关记录)           │   │
│  │  Token: ~200-500                                              │   │
│  │  用途: 理解上下文和关联                                         │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                           │                                         │
│                           ▼                                         │
│  Layer 3: get_observations()                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  返回: 完整的 observation 详情                                 │   │
│  │  Token: ~500-1000 / 结果                                      │   │
│  │  用途: 只在确定需要时获取                                       │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  节省: ~10x tokens (相比直接获取所有详情)                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 隐私控制

```
┌──────────────────────────────────────────────────────────────┐
│                    Privacy Tags                               │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  <private>...</private>                                      │
│                                                              │
│  用法: 在任何用户输入中包裹敏感内容                             │
│  效果: 该内容不会被存储到数据库                                 │
│                                                              │
│  示例:                                                       │
│    "Check my API key: <private>sk-xxxxx</private>"           │
│                                                              │
│  处理位置: chat-capture hook (边缘处理，数据不进入存储层)        │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## 日志系统

```
┌──────────────────────────────────────────────────────────────┐
│                    Logging Control                            │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  环境变量: OPENCODE_MEM_LOG=1                                 │
│                                                              │
│  日志目录: /tmp/claude-mem/                                   │
│    - debug.log  (调试信息)                                    │
│    - info.log   (常规信息)                                    │
│    - warn.log   (警告信息)                                    │
│    - error.log  (错误信息，同时输出到 stderr)                  │
│                                                              │
│  默认: 只输出 error 到 stderr                                  │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

## 技术栈

| 组件 | 技术 |
|------|------|
| Runtime | Bun |
| Database | SQLite3 + FTS5 |
| Vector Search | Chroma (可选) |
| HTTP Server | Bun.serve() |
| UI | Vanilla HTML/CSS/JS |
| AI Compression | OpenCode API (使用配置的 LLM) |

## 文件结构

```
opencode-mem/
├── src/
│   ├── plugin.ts              # 插件入口
│   ├── compression/
│   │   ├── opencode-engine.ts  # AI 压缩引擎
│   │   ├── prompts.ts          # 压缩 prompt 模板
│   │   ├── parser.ts           # XML 解析器
│   │   └── queue-processor.ts  # 异步队列处理
│   ├── db/
│   │   ├── database.ts         # SQLite 连接管理
│   │   ├── migrations.ts       # 数据库迁移
│   │   ├── queries.ts          # SQL 查询
│   │   └── search.ts           # 搜索功能
│   ├── hooks/
│   │   ├── context-injection.ts # 上下文注入
│   │   ├── tool-capture.ts      # 工具事件捕获
│   │   ├── chat-capture.ts      # 聊天捕获
│   │   └── event-handler.ts     # 会话事件
│   ├── mcp/
│   │   ├── server.ts           # MCP 服务器
│   │   ├── http.ts             # HTTP API
│   │   └── tools/              # MCP 工具
│   ├── utils/
│   │   └── logger.ts           # 日志系统
│   └── ui/
│       └── viewer.html         # Web UI
└── dist/                       # 构建输出
```

## 设计决策

### 为什么用 SQLite 而不是其他数据库？

1. **零配置** - 无需单独部署数据库服务
2. **嵌入式** - 与插件同进程，低延迟
3. **FTS5** - 内置全文搜索，性能足够
4. **可靠** - 成熟稳定，数据不易丢失

### 为什么压缩比设计为 10x？

1. **Token 效率** - 原始输出往往包含大量冗余
2. **检索精度** - 压缩后信息密度更高
3. **成本控制** - 减少 AI 处理和存储开销

### 为什么用 3-Layer 搜索？

1. **Token 节省** - 避免不必要地加载完整数据
2. **用户友好** - 先看摘要再决定是否深入了解
3. **渐进披露** - 符合信息架构最佳实践

---

*文档版本: 0.1.0*
*最后更新: 2026-02-12*
